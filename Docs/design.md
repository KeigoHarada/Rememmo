# Rememmo アプリ 基本設計書

## 1. システム概要

### 1.1 システム構成

```
Rememmo App
├── Presentation Layer (SwiftUI Views)
│   ├── ContentView (メモ一覧)
│   ├── MemoDetailView (メモ詳細・編集)
│   ├── AddMemoView (新規メモ作成)
│   ├── MemoCommitHistoryView (コミット履歴)
│   ├── MemoCommitPreviewView (コミット詳細)
│   └── SearchBar (検索機能)
├── Business Logic Layer (ViewModels)
│   ├── MemoViewModel
│   ├── GitService
│   └── SearchViewModel
├── Data Layer
│   ├── SwiftData Models (概要データのみ)
│   ├── Git Repository Management (メモ内容)
│   └── File System Management
└── Infrastructure Layer
    ├── MiniGit Integration
    ├── Error Handling
    └── Logging System
```

### 1.2 技術スタック

- **フロントエンド**: SwiftUI
- **データ管理**: SwiftData (概要) + MiniGit (メモ内容)
- **Git管理**: MiniGit
- **アーキテクチャ**: MVVM + Repository Pattern
- **プラットフォーム**: iOS 17.0+

## 2. データ保存戦略

### 2.1 データ保存の役割分担

#### 2.1.1 SwiftDataの役割（概要データのみ）

- **メモの基本情報**: ID、タイトル、作成日、更新日
- **メタデータ**: 現在のコミットID、タグ、アーカイブ状態
- **UI表示用データ**: 検索・フィルタリング用のインデックス
- **アプリケーション状態**: 現在の編集状態、表示設定

#### 2.1.2 MiniGitの役割（メモ内容の完全保存）

- **メモの完全な内容**: タイトル、本文、フォーマット情報
- **バージョン管理**: 変更履歴、コミット履歴
- **差分管理**: 変更の追跡、復元機能
- **ブランチ管理**: 複数のバージョン管理

### 2.2 メモファイルの保存構造

```
Documents/
├── memos/
│   ├── {memo-id-1}/
│   │   ├── .git/                    # Gitリポジトリ（メモ内容の完全履歴）
│   │   └── memo.md                  # 現在のメモ内容
│   ├── {memo-id-2}/
│   │   ├── .git/
│   │   └── memo.md
│   └── ...
└── app/
    ├── settings.json                # アプリ設定
    └── search_history.json          # 検索履歴
```

### 2.3 データモデルの設計

#### 2.3.1 SwiftDataモデル（Memo.swift）

```swift
@Model
final class Memo {
    var id: UUID                    // メモの一意識別子
    var title: String               // メモタイトル（概要）
    var contentPreview: String      // 内容のプレビュー（最初の100文字）
    var createdAt: Date             // 作成日
    var updatedAt: Date             // 更新日
    var currentCommitId: String?    // 現在のGitコミットID
    var tags: [String]              // タグ
    var isArchived: Bool            // アーカイブ状態
    var wordCount: Int              // 文字数（検索用）
}
```

#### 2.3.2 Git保存形式（memo.md）

```markdown
# メモタイトル

メモの内容をここに記述します。

## 見出し2

- リスト項目1
- リスト項目2

**太字**や*斜体*も使用可能

---
metadata:
  id: memo-uuid
  createdAt: 2025-01-01T00:00:00Z
  updatedAt: 2025-01-01T12:00:00Z
  tags: [タグ1, タグ2]
  wordCount: 150
```

### 2.4 データ操作フロー

#### 2.4.1 メモ作成時

1. **SwiftData**: 基本情報（ID、タイトル、作成日）を保存
2. **Git**: メモ内容をmemo.mdとして保存し、初期コミット
3. **SwiftData**: コミットIDとプレビュー情報を更新

#### 2.4.2 メモ編集時

1. **Git**: 現在の内容をmemo.mdに保存
2. **Git**: 変更をステージングしてコミット
3. **SwiftData**: タイトル、プレビュー、更新日、コミットIDを更新

#### 2.4.3 メモ表示時

1. **SwiftData**: 基本情報とプレビューを取得
2. **Git**: 必要に応じて完全な内容を取得
3. **UI**: 統合されたデータを表示

#### 2.4.4 検索時

1. **SwiftData**: タイトルとプレビューで高速検索
2. **Git**: 必要に応じて内容での全文検索

### 2.5 パフォーマンス最適化

#### 2.5.1 遅延読み込み

- メモ一覧: SwiftDataの概要データのみ表示
- メモ詳細: Gitから完全な内容を読み込み
- 検索結果: プレビューで絞り込み、詳細は必要時のみ

#### 2.5.2 キャッシュ戦略

- **SwiftData**: アプリケーション全体でキャッシュ
- **Git**: メモ単位でキャッシュ、メモリ効率を考慮

#### 2.5.3 同期戦略

- **SwiftData**: リアルタイム同期
- **Git**: 編集完了時に同期

## 3. 画面設計

### 3.1 メイン画面構成

#### 3.1.1 ContentView (メモ一覧画面)

```
┌─────────────────────────────────┐
│ メモ                    [+ボタン] │
├─────────────────────────────────┤
│ [🔍 メモを検索...] [×]          │
├─────────────────────────────────┤
│ ┌─────────────────────────────┐ │
│ │ メモタイトル                 │ │
│ │ メモ内容のプレビュー...       │ │
│ │ 2025/1/1 12:00             │ │
│ └─────────────────────────────┘ │
│ ┌─────────────────────────────┐ │
│ │ 無題                        │ │
│ │ 空のメモのプレビュー...       │ │
│ │ 2025/1/1 10:00             │ │
│ └─────────────────────────────┘ │
└─────────────────────────────────┘
```

#### 3.1.2 MemoDetailView (メモ詳細・編集画面)

```
┌─────────────────────────────────┐
│ ← メモ詳細              [履歴] │
├─────────────────────────────────┤
│ [編集] [保存] [キャンセル]       │
├─────────────────────────────────┤
│ タイトル: [メモタイトル]         │
├─────────────────────────────────┤
│ 内容:                           │
│ ┌─────────────────────────────┐ │
│ │ メモの内容をここに表示       │ │
│ │ 編集モードでは入力可能       │ │
│ │                             │ │
│ └─────────────────────────────┘ │
├─────────────────────────────────┤
│ 作成: 2025/1/1 10:00           │
│ 更新: 2025/1/1 12:00           │
└─────────────────────────────────┘
```

#### 3.1.3 AddMemoView (新規メモ作成画面)

```
┌─────────────────────────────────┐
│ ← 新規メモ作成          [保存] │
├─────────────────────────────────┤
│ タイトル: [                    ] │
├─────────────────────────────────┤
│ 内容:                           │
│ ┌─────────────────────────────┐ │
│ │ メモの内容を入力してください │ │
│ │                             │ │
│ │                             │ │
│ └─────────────────────────────┘ │
└─────────────────────────────────┘
```

#### 3.1.4 MemoCommitHistoryView (コミット履歴画面)

```
┌─────────────────────────────────┐
│ ← コミット履歴                  │
├─────────────────────────────────┤
│ ┌─────────────────────────────┐ │
│ │ ● 内容を更新                 │ │
│ │   2025/1/1 12:00 • main     │ │
│ │   メモ内容のプレビュー...     │ │
│ └─────────────────────────────┘ │
│ ┌─────────────────────────────┐ │
│ │ ● 初回コミット               │ │
│ │   2025/1/1 10:00 • main     │ │
│ │   メモ内容のプレビュー...     │ │
│ └─────────────────────────────┘ │
└─────────────────────────────────┘
```

#### 3.1.5 MemoCommitPreviewView (コミット詳細画面)

```
┌─────────────────────────────────┐
│ ← コミット詳細          [復元] │
├─────────────────────────────────┤
│ コミット: 内容を更新             │
│ 日時: 2025/1/1 12:00           │
│ ブランチ: main                  │
├─────────────────────────────────┤
│ 差分:                           │
│ ┌─────────────────────────────┐ │
│ │ + 新しい行が追加されました   │ │
│ │ - 古い行が削除されました     │ │
│ │  変更されていない行          │ │
│ └─────────────────────────────┘ │
├─────────────────────────────────┤
│ 内容:                           │
│ ┌─────────────────────────────┐ │
│ │ コミット時のメモ内容         │ │
│ └─────────────────────────────┘ │
└─────────────────────────────────┘
```

### 3.2 ナビゲーション構造

```
ContentView (メイン)
├── AddMemoView (モーダル)
├── MemoDetailView
│   └── MemoCommitHistoryView
│       └── MemoCommitPreviewView (モーダル)
└── SearchResultsView (検索結果)
```

## 4. エラーの種類とハンドリング

### 4.1 エラー分類

#### 4.1.1 データエラー

- **MemoNotFoundError**: メモが見つからない
- **InvalidDataError**: データ形式が不正
- **CorruptedDataError**: データが破損している

#### 4.1.2 Git操作エラー

- **GitRepositoryError**: リポジトリ操作失敗
- **GitCommitError**: コミット操作失敗
- **GitBranchError**: ブランチ操作失敗
- **GitMergeError**: マージ操作失敗

#### 4.1.3 ファイルシステムエラー

- **FileNotFoundError**: ファイルが見つからない
- **FilePermissionError**: ファイルアクセス権限エラー
- **DiskSpaceError**: ディスク容量不足
- **FileCorruptionError**: ファイル破損

#### 4.1.4 ネットワークエラー

- **NetworkConnectionError**: ネットワーク接続エラー
- **TimeoutError**: タイムアウトエラー

#### 4.1.5 アプリケーションエラー

- **ValidationError**: 入力値検証エラー
- **StateError**: アプリケーション状態エラー
- **ConfigurationError**: 設定エラー

### 4.2 エラーハンドリング方法

#### 4.2.1 エラー処理の階層

```
1. Presentation Layer (ユーザーへの表示)
2. Business Logic Layer (ビジネスロジック処理)
3. Data Layer (データ操作処理)
4. Infrastructure Layer (基盤処理)
```

#### 4.2.2 エラー処理パターン

**1. 即座に回復可能なエラー**

```swift
// 例: 検索結果が0件
if searchResults.isEmpty {
    showEmptyState(message: "検索結果が見つかりません")
}
```

**2. ユーザー操作で回復可能なエラー**

```swift
// 例: ファイル保存失敗
catch FilePermissionError {
    showAlert(
        title: "保存エラー",
        message: "ファイルの保存に失敗しました。権限を確認してください。",
        actions: [retryAction, cancelAction]
    )
}
```

**3. 自動回復を試行するエラー**

```swift
// 例: ネットワーク接続エラー
catch NetworkConnectionError {
    retryWithExponentialBackoff(maxAttempts: 3) {
        performNetworkOperation()
    }
}
```

**4. アプリケーション再起動が必要なエラー**

```swift
// 例: データベース破損
catch DatabaseCorruptionError {
    showCriticalError(
        title: "重大なエラー",
        message: "アプリケーションを再起動してください。",
        action: restartApp
    )
}
```

#### 4.2.3 エラーログ記録

```swift
struct ErrorLogger {
    static func log(_ error: Error, context: String) {
        // エラーの詳細をログに記録
        // クラッシュレポート送信
        // 開発者への通知
    }
}
```

## 5. 全体アーキテクチャ

### 5.1 アーキテクチャパターン

**MVVM + Repository Pattern**

```
┌─────────────────────────────────────────────────────────┐
│                    Presentation Layer                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ ContentView │  │DetailView   │  │ HistoryView │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│                   Business Logic Layer                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │MemoViewModel│  │GitService   │  │SearchService│     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│                      Data Layer                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │MemoRepository│  │GitRepository│  │FileRepository│     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│                  Infrastructure Layer                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ SwiftData   │  │ SwiftGit2   │  │ FileSystem  │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
```

### 5.2 依存関係の方向

- **Presentation → Business Logic**: ViewModelsを使用
- **Business Logic → Data**: Repositoryインターフェースを使用
- **Data → Infrastructure**: 具体的な実装を使用

### 5.3 データフロー

```
1. ユーザーアクション
   ↓
2. View → ViewModel
   ↓
3. ViewModel → Repository
   ↓
4. Repository → Infrastructure
   ↓
5. データ更新
   ↓
6. ViewModel → View (UI更新)
```

### 5.4 状態管理

- **SwiftData**: 永続化データ
- **@State/@Binding**: ローカル状態
- **@ObservableObject**: ビジネスロジック状態
- **@Environment**: アプリ全体の状態

この設計により、保守性、拡張性、テスト可能性を確保し、ユーザビリティを重視したアプリケーションを構築できます。
