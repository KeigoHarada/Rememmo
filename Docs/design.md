# Rememmo アプリ 基本設計書

## 1. システム概要

### 1.1 システム構成

```
Rememmo App
├── Presentation Layer (SwiftUI Views)
│   ├── ContentView (メモ一覧)
│   ├── MemoDetailView (メモ詳細・編集)
│   ├── AddMemoView (新規メモ作成)
│   ├── MemoCommitHistoryView (コミット履歴)
│   ├── MemoCommitPreviewView (コミット詳細)
│   └── SearchBar (検索機能)
├── Business Logic Layer (ViewModels)
│   ├── MemoViewModel
│   ├── GitService
│   └── SearchViewModel
├── Data Layer
│   ├── SwiftData Models
│   ├── Git Repository Management
│   └── File System Management
└── Infrastructure Layer
    ├── SwiftGit2 Integration
    ├── Error Handling
    └── Logging System
```

### 1.2 技術スタック

- **フロントエンド**: SwiftUI
- **データ管理**: SwiftData
- **Git管理**: SwiftGit2
- **アーキテクチャ**: MVVM + Repository Pattern
- **プラットフォーム**: iOS 17.0+

## 2. ファイル保存方式

### 2.1 メモファイルの保存構造

```
Documents/
├── memos/
│   ├── {memo-id-1}/
│   │   ├── .git/                    # Gitリポジトリ
│   │   ├── memo.md                  # 現在のメモ内容
│   │   └── metadata.json            # メタデータ
│   ├── {memo-id-2}/
│   │   ├── .git/
│   │   ├── memo.md
│   │   └── metadata.json
│   └── ...
└── app/
    ├── settings.json                # アプリ設定
    └── search_history.json          # 検索履歴
```

### 2.2 ファイル形式

#### 2.2.1 メモファイル (memo.md)

```markdown
# メモタイトル

メモの内容をここに記述します。

## 見出し2

- リスト項目1
- リスト項目2

**太字**や*斜体*も使用可能
```

#### 2.2.2 メタデータファイル (metadata.json)

```json
{
  "id": "memo-uuid",
  "title": "メモタイトル",
  "createdAt": "2025-01-01T00:00:00Z",
  "updatedAt": "2025-01-01T12:00:00Z",
  "currentCommitId": "commit-hash",
  "currentBranch": "main",
  "tags": ["タグ1", "タグ2"],
  "isArchived": false
}
```

### 2.3 Git管理方式

- 各メモフォルダに独立したGitリポジトリを作成
- メモ編集時に自動コミット
- コミットメッセージは変更内容に基づいて自動生成
- ブランチ機能でバージョン管理

## 3. 画面設計

### 3.1 メイン画面構成

#### 3.1.1 ContentView (メモ一覧画面)

```
┌─────────────────────────────────┐
│ メモ                    [+ボタン] │
├─────────────────────────────────┤
│ [🔍 メモを検索...] [×]          │
├─────────────────────────────────┤
│ ┌─────────────────────────────┐ │
│ │ メモタイトル                 │ │
│ │ メモ内容のプレビュー...       │ │
│ │ 2025/1/1 12:00             │ │
│ └─────────────────────────────┘ │
│ ┌─────────────────────────────┐ │
│ │ 無題                        │ │
│ │ 空のメモのプレビュー...       │ │
│ │ 2025/1/1 10:00             │ │
│ └─────────────────────────────┘ │
└─────────────────────────────────┘
```

#### 3.1.2 MemoDetailView (メモ詳細・編集画面)

```
┌─────────────────────────────────┐
│ ← メモ詳細              [履歴] │
├─────────────────────────────────┤
│ [編集] [保存] [キャンセル]       │
├─────────────────────────────────┤
│ タイトル: [メモタイトル]         │
├─────────────────────────────────┤
│ 内容:                           │
│ ┌─────────────────────────────┐ │
│ │ メモの内容をここに表示       │ │
│ │ 編集モードでは入力可能       │ │
│ │                             │ │
│ └─────────────────────────────┘ │
├─────────────────────────────────┤
│ 作成: 2025/1/1 10:00           │
│ 更新: 2025/1/1 12:00           │
└─────────────────────────────────┘
```

#### 3.1.3 AddMemoView (新規メモ作成画面)

```
┌─────────────────────────────────┐
│ ← 新規メモ作成          [保存] │
├─────────────────────────────────┤
│ タイトル: [                    ] │
├─────────────────────────────────┤
│ 内容:                           │
│ ┌─────────────────────────────┐ │
│ │ メモの内容を入力してください │ │
│ │                             │ │
│ │                             │ │
│ └─────────────────────────────┘ │
└─────────────────────────────────┘
```

#### 3.1.4 MemoCommitHistoryView (コミット履歴画面)

```
┌─────────────────────────────────┐
│ ← コミット履歴                  │
├─────────────────────────────────┤
│ ┌─────────────────────────────┐ │
│ │ ● 内容を更新                 │ │
│ │   2025/1/1 12:00 • main     │ │
│ │   メモ内容のプレビュー...     │ │
│ └─────────────────────────────┘ │
│ ┌─────────────────────────────┐ │
│ │ ● 初回コミット               │ │
│ │   2025/1/1 10:00 • main     │ │
│ │   メモ内容のプレビュー...     │ │
│ └─────────────────────────────┘ │
└─────────────────────────────────┘
```

#### 3.1.5 MemoCommitPreviewView (コミット詳細画面)

```
┌─────────────────────────────────┐
│ ← コミット詳細          [復元] │
├─────────────────────────────────┤
│ コミット: 内容を更新             │
│ 日時: 2025/1/1 12:00           │
│ ブランチ: main                  │
├─────────────────────────────────┤
│ 差分:                           │
│ ┌─────────────────────────────┐ │
│ │ + 新しい行が追加されました   │ │
│ │ - 古い行が削除されました     │ │
│ │  変更されていない行          │ │
│ └─────────────────────────────┘ │
├─────────────────────────────────┤
│ 内容:                           │
│ ┌─────────────────────────────┐ │
│ │ コミット時のメモ内容         │ │
│ └─────────────────────────────┘ │
└─────────────────────────────────┘
```

### 3.2 ナビゲーション構造

```
ContentView (メイン)
├── AddMemoView (モーダル)
├── MemoDetailView
│   └── MemoCommitHistoryView
│       └── MemoCommitPreviewView (モーダル)
└── SearchResultsView (検索結果)
```

## 4. エラーの種類とハンドリング

### 4.1 エラー分類

#### 4.1.1 データエラー

- **MemoNotFoundError**: メモが見つからない
- **InvalidDataError**: データ形式が不正
- **CorruptedDataError**: データが破損している

#### 4.1.2 Git操作エラー

- **GitRepositoryError**: リポジトリ操作失敗
- **GitCommitError**: コミット操作失敗
- **GitBranchError**: ブランチ操作失敗
- **GitMergeError**: マージ操作失敗

#### 4.1.3 ファイルシステムエラー

- **FileNotFoundError**: ファイルが見つからない
- **FilePermissionError**: ファイルアクセス権限エラー
- **DiskSpaceError**: ディスク容量不足
- **FileCorruptionError**: ファイル破損

#### 4.1.4 ネットワークエラー

- **NetworkConnectionError**: ネットワーク接続エラー
- **TimeoutError**: タイムアウトエラー

#### 4.1.5 アプリケーションエラー

- **ValidationError**: 入力値検証エラー
- **StateError**: アプリケーション状態エラー
- **ConfigurationError**: 設定エラー

### 4.2 エラーハンドリング方法

#### 4.2.1 エラー処理の階層

```
1. Presentation Layer (ユーザーへの表示)
2. Business Logic Layer (ビジネスロジック処理)
3. Data Layer (データ操作処理)
4. Infrastructure Layer (基盤処理)
```

#### 4.2.2 エラー処理パターン

**1. 即座に回復可能なエラー**

```swift
// 例: 検索結果が0件
if searchResults.isEmpty {
    showEmptyState(message: "検索結果が見つかりません")
}
```

**2. ユーザー操作で回復可能なエラー**

```swift
// 例: ファイル保存失敗
catch FilePermissionError {
    showAlert(
        title: "保存エラー",
        message: "ファイルの保存に失敗しました。権限を確認してください。",
        actions: [retryAction, cancelAction]
    )
}
```

**3. 自動回復を試行するエラー**

```swift
// 例: ネットワーク接続エラー
catch NetworkConnectionError {
    retryWithExponentialBackoff(maxAttempts: 3) {
        performNetworkOperation()
    }
}
```

**4. アプリケーション再起動が必要なエラー**

```swift
// 例: データベース破損
catch DatabaseCorruptionError {
    showCriticalError(
        title: "重大なエラー",
        message: "アプリケーションを再起動してください。",
        action: restartApp
    )
}
```

#### 4.2.3 エラーログ記録

```swift
struct ErrorLogger {
    static func log(_ error: Error, context: String) {
        // エラーの詳細をログに記録
        // クラッシュレポート送信
        // 開発者への通知
    }
}
```

## 5. 全体アーキテクチャ

### 5.1 アーキテクチャパターン

**MVVM + Repository Pattern**

```
┌─────────────────────────────────────────────────────────┐
│                    Presentation Layer                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ ContentView │  │DetailView   │  │ HistoryView │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│                   Business Logic Layer                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │MemoViewModel│  │GitService   │  │SearchService│     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│                      Data Layer                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │MemoRepository│  │GitRepository│  │FileRepository│     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│                  Infrastructure Layer                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ SwiftData   │  │ SwiftGit2   │  │ FileSystem  │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────┘
```

### 5.2 依存関係の方向

- **Presentation → Business Logic**: ViewModelsを使用
- **Business Logic → Data**: Repositoryインターフェースを使用
- **Data → Infrastructure**: 具体的な実装を使用

### 5.3 データフロー

```
1. ユーザーアクション
   ↓
2. View → ViewModel
   ↓
3. ViewModel → Repository
   ↓
4. Repository → Infrastructure
   ↓
5. データ更新
   ↓
6. ViewModel → View (UI更新)
```

### 5.4 状態管理

- **SwiftData**: 永続化データ
- **@State/@Binding**: ローカル状態
- **@ObservableObject**: ビジネスロジック状態
- **@Environment**: アプリ全体の状態

この設計により、保守性、拡張性、テスト可能性を確保し、ユーザビリティを重視したアプリケーションを構築できます。
